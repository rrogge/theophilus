---
title: "Theophilus"
author: "Ralph Rogge (RRO)"
date: "4/28/2018"
output: html_document
---

Clean up
```{r}
rm(list=ls())
```

Load external libraries
```{r, message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
```

Crater center
```{r}
center <- list(l = 26.28, b = -11.45)
```

Function to convert degrees to rad.
```{r}
# d - degrees.
to.rad <- function(d) return(d*pi/180)
```

Function to calculate distance on a sphere (Moon radius as default value).
```{r}
# l1 - Longitude of point 1
# b1 - Latitude of point 1
# l2 - Longitude of point 2
# b2 - Latitude of point 2
# r - Sphere radius
distance <- function(l1, b1, l2, b2, r=1738) {
    sin2 <- sin(to.rad(b1)) * sin(to.rad(b2))
    cos2 <- cos(to.rad(b1)) * cos(to.rad(b2))
    d <- r *  acos(sin2 + cos2 * cos(to.rad(l2-l1)))
    return(d)
}
```

Function to read and preprocess height profile data from file
```{r}
# file - File name or connection.
# direction - (String) Tag to identify profile.
read.profile <- function(file, direction) {
    raw <- read.csv(file, skip=4)
    df <- raw %>%
        rename(a = position) %>%
        rename(h = GLD100) %>%
        rename(l = lon) %>%
        rename(b = lat) %>%
        mutate(direction = direction) %>%
        select(l, b, h, a, direction)
    return(df)
}
```

Read height profiles from file
```{r}
profile.000_180 <- read.profile("input/profile_000-180.txt", direction="000-180")
profile.090_270 <- read.profile("input/profile_090-270.txt", direction="090-270")
```

Distance relative to crater center
```{r}
dr <- distance(profile.000_180$l, profile.000_180$b, center$l, center$b)
profile.000_180$dr <- sign(profile.000_180$a - profile.000_180$a[which.min(dr)]) * dr

dr <- distance(profile.090_270$l, profile.090_270$b, center$l, center$b)
profile.090_270$dr <- sign(profile.090_270$a - profile.090_270$a[which.min(dr)]) * dr
```

Combine profile data
```{r}
data <-rbind(profile.000_180, profile.090_270)
```

Search radius for lowest and highest point within the crater
```{r}
radius <- 25 # km
```

Height relative to lowest point within crater
```{r}
inside <- data[abs(data$dr) < radius,]
index <- which.min(inside$h)
data$dh <- data$h - inside$h[index]
```

Lowest/highest point of central peak
```{r}
inside <- data[abs(data$dr) < radius,]
inside[which.min(inside$dh),]
inside[which.max(inside$dh),]
```
```

Plot profiles
```{r}
ggplot(data) +
    geom_line(aes(dr, dh, color=direction)) +
    labs(x="Distance from Center [km]", y="Height above Crater Base [m]", title="Height Profile") +
    theme_bw()
```

Write profiles to file
```{r}
if (!dir.exists("output")) dir.create("output")
df <- data %>% select(dr, dh, h, direction)
write.csv(df, "output/profiles.csv", row.names=FALSE)
```

